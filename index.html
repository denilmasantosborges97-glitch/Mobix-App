<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eco-Planeta M√°gico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
            transition: background-color 3s linear;
        }
        h1, h2, h3 {
            font-family: 'Fredoka One', cursive;
        }
        /* --- ESTILOS DO MENU INICIAL --- */
        @keyframes float-menu-item {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        .menu-floater {
            position: absolute;
            animation: float-menu-item 6s ease-in-out infinite;
            opacity: 0.8;
            pointer-events: none;
        }
        .menu-floater:nth-child(2) { animation-delay: -2s; animation-duration: 7s; }
        .menu-floater:nth-child(3) { animation-delay: -4s; animation-duration: 5s; }
        .menu-floater:nth-child(4) { animation-delay: -1s; animation-duration: 8s; }
        .menu-floater:nth-child(5) { animation-delay: -3s; animation-duration: 6.5s; }

        @keyframes title-glow {
            0%, 100% { text-shadow: 4px 4px 0px rgba(0,0,0,0.2), 0 0 10px #fff; }
            50% { text-shadow: 4px 4px 0px rgba(0,0,0,0.2), 0 0 20px #fef08a; }
        }
        #main-menu h1 {
            animation: title-glow 4s infinite ease-in-out;
        }
        
        @keyframes start-button-pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 15px 5px #fde047; }
            50% { transform: scale(1.05); box-shadow: 0 0 30px 10px #fde047; }
        }
        #start-game-btn {
            animation: start-button-pulse 2s infinite;
        }
        
        @keyframes fade-out-menu {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(1.1); pointer-events: none; }
        }
        .menu-hiding {
            animation: fade-out-menu 0.7s ease-out forwards;
        }
        /* --- FIM DOS ESTILOS DO MENU --- */
        .celestial-body {
            position: absolute;
            z-index: -1;
            transition: opacity 3s linear; 
        }
        .sun-glow {
            box-shadow: 0 0 20px 10px #fef08a, 0 0 40px 20px #fde047;
        }
        .moon-glow {
            box-shadow: 0 0 25px 10px #e2e8f0, 0 0 50px 20px #cbd5e1;
        }
        .planet-item {
            position: absolute;
            transform-origin: bottom center;
            transition: transform 0.2s ease-in-out, opacity 0.5s ease-in-out;
            z-index: 10;
        }
        .planet-item:hover {
            transform: scale(1.1);
        }
        .clickable {
            cursor: grab;
            transition: transform 0.1s ease-out;
        }
        .clickable:active {
            transform: scale(0.95);
            cursor: grabbing;
        }
        @keyframes fall {
            0% { transform: translateY(-100px); opacity: 1; }
            100% { transform: translateY(0); opacity: 0; }
        }
        .falling-drop {
            position: absolute;
            animation: fall 1s linear;
            pointer-events: none;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        .floating-text {
            animation: float-up 1.5s ease-out forwards;
            position: absolute;
            pointer-events: none;
            font-size: 1.25rem;
            font-weight: bold;
        }
        @keyframes float-up {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
        .energy-particle {
            position: absolute;
            z-index: 20;
            pointer-events: none;
            animation: float-up-particle 2s ease-out forwards;
            color: #fde047;
            text-shadow: 0 0 5px #fff;
            font-size: 1rem;
        }
        @keyframes float-up-particle {
            0% { transform: translateY(0) scale(0.5); opacity: 1; }
            100% { transform: translateY(-40px) scale(1); opacity: 0; }
        }
        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes buzz {
            0%   { transform: translate(0, 0); }
            20%  { transform: translate(-2px, 2px) rotate(-5deg); }
            40%  { transform: translate(2px, -2px) rotate(5deg); }
            60%  { transform: translate(-2px, -2px) rotate(-5deg); }
            80%  { transform: translate(2px, 2px) rotate(5deg); }
            100% { transform: translate(0, 0); }
        }
        @keyframes hop {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        .planet-item[data-item-type="sapling"] span,
        .planet-item[data-item-type="flower"] span,
        .planet-item[data-item-type="adultTree"] span,
        .planet-item[data-item-type="cosmicFlower"] span,
        .planet-item[data-item-type="mushroom"] span {
            display: inline-block;
            animation: breathe 5s infinite ease-in-out;
        }
        .planet-item[data-item-type="bee"] span {
            display: inline-block;
            animation: buzz 0.3s infinite linear;
        }
        .planet-item[data-item-type="squirrel"] span {
            display: inline-block;
            animation: hop 1.5s infinite ease-in-out;
        }
         .planet-item[data-item-type="firefly"] span {
            display: inline-block;
            animation: twinkle 3s infinite;
        }
        .planet-item[data-item-type="frog"] span {
            display: inline-block;
            animation: hop 2s infinite ease-in-out;
        }
        .planet-item[data-item-type="songbird"] span {
             display: inline-block;
            animation: breathe 4s infinite ease-in-out;
        }
        .planet-item:nth-child(odd) span {
            animation-delay: -1.5s;
        }
        .shop-item {
            position: relative;
        }
        .custom-tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2d3748;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            z-index: 10;
            width: max-content;
            transition: opacity 0.2s ease-in-out;
            pointer-events: none;
            font-size: 0.75rem;
        }
        .shop-item:hover .custom-tooltip {
            visibility: visible;
            opacity: 1;
        }
        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle 2s infinite alternate;
        }
        @keyframes twinkle {
            from { opacity: 0.5; }
            to { opacity: 1; }
        }
        @keyframes slide-in-down {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fade-out-up {
             0% { transform: translateY(0); opacity: 1; }
            80% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-100%); opacity: 0; }
        }
        .toast-notification {
            animation: slide-in-down 0.5s ease-out forwards, fade-out-up 0.5s ease-in 4.5s forwards;
        }
        .pollution-cloud {
            animation: pulse 3s infinite;
            filter: drop-shadow(0 0 5px rgba(0,0,0,0.5));
        }
        .encyclopedia-entry.locked {
            filter: grayscale(1) brightness(0.5);
        }
        .rain-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 25;
        }
        @keyframes fall-rain {
            from { transform: translateY(-10vh); }
            to { transform: translateY(110vh); }
        }
        .raindrop {
            position: absolute;
            animation-name: fall-rain;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
            color: #60a5fa;
        }
        #planet {
            overflow: hidden;
        }
        #planet-features {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        #planet-features svg {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            transition: opacity 2s ease-in-out, fill 2s ease-in-out;
            opacity: 0;
        }
        #event-elements-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20;
        }
        @keyframes spawn-in {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .spawn-animation {
            animation: spawn-in 0.3s ease-out forwards;
        }
        .bonus-btn .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .progress-bar {
            background-color: #e0e0e0;
            border-radius: 10px;
            height: 10px;
            width: 100%;
        }
        .progress-bar-fill {
            background-color: #4caf50;
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease-in-out;
        }
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px 2px #fde047; }
            50% { box-shadow: 0 0 15px 5px #fde047; }
        }
        .reward-ready {
            animation: glow 2s infinite;
        }
        
        @keyframes shooting-star-path {
            0% { transform: translate(-100px, -100px) scale(0.5); opacity: 1; }
            100% { transform: translate(100vw, 100vh) scale(1); opacity: 0; }
        }
        #shooting-star {
            position: absolute;
            z-index: 50;
            pointer-events: auto;
            cursor: pointer;
            animation: shooting-star-path 4s linear forwards;
            color: white;
            text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #fef08a;
        }
        @keyframes comet-path {
            from { transform: translate(-100px, 150px) rotate(-30deg); }
            to { transform: translate(110vw, -50px) rotate(-30deg); }
        }
        #comet {
            position: absolute;
            z-index: 50;
            pointer-events: auto;
            cursor: pointer;
            animation: comet-path 10s linear;
            color: #bfdbfe;
            text-shadow: 0 0 15px #60a5fa;
        }
        @keyframes star-seed-pulse {
             0%, 100% { transform: scale(1); box-shadow: 0 0 15px 5px #a78bfa; }
            50% { transform: scale(1.1); box-shadow: 0 0 30px 10px #a78bfa; }
        }
        #star-seed-button {
             animation: star-seed-pulse 2s infinite;
        }
        @keyframes move-cloud {
            from { transform: translateX(-150px); }
            to { transform: translateX(110vw); }
        }
        .sky-cloud {
            position: absolute;
            top: 10%;
            font-size: 3rem;
            opacity: 0.3;
            animation-name: move-cloud;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }
        @keyframes smoke-puff {
            0% { transform: translateY(0) scale(0.5); opacity: 0.5;}
            100% { transform: translateY(-40px) scale(1.5); opacity: 0;}
        }
        .smoke {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 10px;
            height: 10px;
            background: #a1a1aa;
            border-radius: 50%;
            animation: smoke-puff 3s linear infinite;
        }
        .factory {
             filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));
        }
    </style>
</head>
<body class="bg-sky-200 text-gray-800 overflow-hidden select-none">
    
    <div id="main-menu" class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-sky-400 to-emerald-400 flex flex-col items-center justify-center z-50">
        <h1 class="text-6xl sm:text-8xl text-white font-bold mb-4 text-center" style="text-shadow: 4px 4px 0px rgba(0,0,0,0.2);">Eco-Planeta M√°gico</h1>
        <p class="text-white text-xl sm:text-2xl mb-8">Ajude a dar vida a um novo mundo!</p>
        <button id="start-game-btn" class="text-3xl bg-yellow-400 text-white font-bold py-4 px-8 rounded-full shadow-lg hover:bg-yellow-500 transition transform hover:scale-105">
            Jogar!
        </button>
        <div class="menu-floater" style="font-size: 4rem; top: 15%; left: 10%;">üåç</div>
        <div class="menu-floater" style="font-size: 3rem; top: 70%; left: 20%;">üå±</div>
        <div class="menu-floater" style="font-size: 2.5rem; top: 25%; left: 85%;">‚ú®</div>
        <div class="menu-floater" style="font-size: 3.5rem; top: 80%; left: 90%;">üå≥</div>
        <div class="menu-floater" style="font-size: 2rem; top: 50%; left: 5%;">üíß</div>
    </div>


    <div id="game-container" class="relative w-screen h-screen flex flex-col items-center justify-center">
        
        <div id="sky-elements-container" class="absolute top-0 left-0 w-full h-full pointer-events-none z-[-2]"></div>
        
        <div id="sun" class="celestial-body sun-glow top-1/2 -left-24 w-24 h-24 bg-yellow-300 rounded-full"></div>
        <div id="moon" class="celestial-body moon-glow top-1/2 -left-16 w-16 h-16 bg-gray-200 rounded-full shadow-lg opacity-0"></div>
        <div id="stars-container" class="absolute top-0 left-0 w-full h-full pointer-events-none"></div>

        <div id="notification-area" class="absolute top-[28%] sm:top-[25%] left-1/2 -translate-x-1/2 w-full max-w-xs flex flex-col items-center gap-3 z-30 pointer-events-none">
            </div>

        <div id="special-events-container" class="absolute top-0 left-0 w-full h-full pointer-events-none"></div>

        <div class="absolute top-4 right-4 flex flex-col items-end gap-2 text-white bg-black/20 p-4 rounded-xl shadow-lg z-10">
            <div id="star-seed-display" class="hidden items-center gap-2">
                 <span id="star-seed-count" class="text-2xl font-bold">0</span> ‚ú®
            </div>
            <div class="flex items-center gap-2">
                <span id="water-count" class="text-2xl font-bold">0</span> üíß
            </div>
            <div class="flex items-center gap-2">
                <span id="energy-count" class="text-2xl font-bold">0</span> ‚ú® (<span id="energy-per-second" class="text-lg">0</span>/s)
            </div>
        </div>

        <div id="planet" class="relative w-[350px] h-[350px] sm:w-[450px] sm:h-[450px] rounded-full flex items-center justify-center shadow-2xl">
            <div id="planet-features">
                 <svg id="ground-layer" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" style="opacity: 1;">
                    <defs>
                        <radialGradient id="groundGradient">
                            <stop offset="70%" stop-color="#5c4033" />
                            <stop offset="100%" stop-color="#4a2e23" />
                        </radialGradient>
                    </defs>
                    <circle cx="50" cy="50" r="50" fill="url(#groundGradient)" />
                </svg>
                <svg id="grass-layer" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="50" fill="#228B22" />
                </svg>
                <svg id="river-layer" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <path d="M 20,0 C 30,30 10,70 40,100" stroke="#3b82f6" stroke-width="6" fill="none" stroke-linecap="round"/>
                    <path d="M 70,0 C 80,40 50,80 80,100" stroke="#3b82f6" stroke-width="4" fill="none" stroke-linecap="round"/>
                </svg>
                 <svg id="mountain-layer" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <polygon points="50,15 65,45 35,45" fill="#a0aec0"/>
                    <polygon points="60,25 78,50 42,50" fill="#718096"/>
                </svg>
            </div>
            <div id="event-elements-container"></div>
        </div>
        
        <div id="cloud" class="absolute top-[15%] sm:top-[10%] w-48 h-24 bg-white rounded-full clickable shadow-xl flex items-center justify-center -mt-12 z-10">
            <h2 class="text-blue-400">Pegar √Ågua</h2>
        </div>

        <div class="absolute bottom-0 w-full bg-black/20 p-2 text-white z-10">
            <div class="flex justify-center gap-2 md:gap-4 max-w-6xl mx-auto flex-wrap">
                <div class="flex flex-col items-center bg-green-800/80 p-3 rounded-lg shadow-md">
                    <h3 class="text-lg mb-2">Plantar</h3>
                    <div class="flex gap-2">
                        <button id="buy-sapling" class="shop-item pulse-animation flex items-center p-2 rounded-lg bg-green-600 hover:bg-green-500 transition w-32 h-12 justify-center">
                            <span>Muda (<span id="sapling-cost">10</span>üíß)</span>
                            <div class="custom-tooltip">Gera: +1 ‚ú®/s</div>
                        </button>
                        <button id="buy-flower" class="shop-item flex items-center p-2 rounded-lg bg-green-600 hover:bg-green-500 transition disabled:opacity-50 w-32 h-12 justify-center" disabled>
                            <span>Flor (<span id="flower-cost">50</span>üíß)</span>
                            <div class="custom-tooltip">Gera: +5 ‚ú®/s<br><span id="flower-hint">üîí Requer 10 ‚ú®/s</span></div>
                        </button>
                    </div>
                </div>
                <div class="flex flex-col items-center bg-gray-700/80 p-3 rounded-lg shadow-md">
                    <h3 class="text-lg mb-2">Limpeza</h3>
                     <button id="cleanup-button" class="shop-item flex items-center p-2 rounded-lg bg-gray-500 hover:bg-gray-400 transition disabled:opacity-50 w-32 h-12 justify-center" disabled>
                        <span>Limpar (<span id="cleanup-cost">100</span>‚ú®)</span>
                         <div class="custom-tooltip"><span id="cleanup-hint">üîí Requer 20 ‚ú®/s</span></div>
                    </button>
                </div>
                <div id="animal-shop" class="hidden flex-col items-center bg-orange-700/80 p-3 rounded-lg shadow-md">
                    <h3 class="text-lg mb-2">Animais</h3>
                     <div class="flex gap-2">
                         <button id="buy-bee" class="shop-item flex items-center p-2 rounded-lg bg-orange-500 hover:bg-orange-400 transition disabled:opacity-50 w-32 h-12 justify-center" disabled>
                            <span>Abelha (<span id="bee-cost">500</span>‚ú®)</span>
                            <div class="custom-tooltip">Gera: +10 ‚ú®/s<br><span id="bee-hint">üîí Limpe mais!</span></div>
                        </button>
                        <button id="buy-squirrel" class="shop-item flex items-center p-2 rounded-lg bg-orange-500 hover:bg-orange-400 transition disabled:opacity-50 w-32 h-12 justify-center" disabled>
                            <span>Esquilo (<span id="squirrel-cost">1000</span>‚ú®)</span>
                            <div class="custom-tooltip">Acha üíß b√¥nus!<br><span id="squirrel-hint">üîí Atraia abelhas!</span></div>
                        </button>
                     </div>
                </div>
                <div class="flex flex-col items-center bg-blue-800/80 p-3 rounded-lg shadow-md">
                    <h3 class="text-lg mb-2">Melhorias</h3>
                    <div class="flex gap-2">
                        <button id="upgrade-click" class="shop-item flex items-center p-2 rounded-lg bg-blue-600 hover:bg-blue-500 transition w-36 h-12 justify-center text-center">
                           <span>Nuvem Maior (<span id="click-upgrade-cost">25</span>üíß)</span>
                           <div class="custom-tooltip">B√≥nus: +<span id="click-upgrade-bonus">1</span>üíß/clique</div>
                        </button>
                         <button id="upgrade-auto" class="shop-item flex items-center p-2 rounded-lg bg-blue-600 hover:bg-blue-500 transition disabled:opacity-50 w-32 h-12 justify-center" disabled>
                           <span>P√°ssaro (<span id="auto-upgrade-cost">200</span>‚ú®)</span>
                           <div class="custom-tooltip">Gera: +<span id="auto-upgrade-bonus">1</span>üíß/s<br><span id="auto-hint">üîí Limpe o planeta!</span></div>
                        </button>
                    </div>
                </div>
                 <div id="bonus-section" class="flex-col items-center bg-purple-800/80 p-3 rounded-lg shadow-md hidden">
                    <h3 class="text-lg mb-2">B√≥nus</h3>
                    <div class="flex gap-2">
                        <button id="autoclick-bonus-btn" class="shop-item bonus-btn relative flex items-center justify-center p-2 rounded-lg bg-purple-600 hover:bg-purple-500 transition disabled:opacity-50 w-16 h-12 text-2xl" disabled>
                            <span>üëÜ</span>
                            <div class="badge hidden">0</div>
                            <div class="custom-tooltip">Cliques Autom√°ticos (30s)</div>
                        </button>
                        <button id="energy-bonus-btn" class="shop-item bonus-btn relative flex items-center justify-center p-2 rounded-lg bg-purple-600 hover:bg-purple-500 transition disabled:opacity-50 w-16 h-12 text-2xl" disabled>
                            <span>‚ö°Ô∏è</span>
                            <div class="badge hidden">0</div>
                            <div class="custom-tooltip">Explos√£o de Energia</div>
                        </button>
                         <button id="growth-bonus-btn" class="shop-item bonus-btn relative flex items-center justify-center p-2 rounded-lg bg-purple-600 hover:bg-purple-500 transition disabled:opacity-50 w-16 h-12 text-2xl" disabled>
                            <span>üå±</span>
                            <div class="badge hidden">0</div>
                            <div class="custom-tooltip">Super Crescimento (60s)</div>
                        </button>
                    </div>
                </div>
                <div class="flex flex-col items-center bg-gray-600/80 p-3 rounded-lg shadow-md">
                    <h3 class="text-lg mb-2">Op√ß√µes</h3>
                    <div class="flex gap-2">
                         <button id="missions-button" class="shop-item flex items-center justify-center p-2 rounded-lg bg-yellow-800 hover:bg-yellow-700 transition w-16 h-12 text-2xl">
                            <span>üìú</span>
                            <div class="custom-tooltip">Miss√µes</div>
                        </button>
                         <button id="how-to-play-button" class="shop-item flex items-center justify-center p-2 rounded-lg bg-gray-500 hover:bg-gray-400 transition w-16 h-12 text-2xl">
                            <span>‚ùì</span>
                            <div class="custom-tooltip">Como Jogar</div>
                        </button>
                        <button id="tips-button" class="shop-item flex items-center justify-center p-2 rounded-lg bg-teal-600 hover:bg-teal-500 transition w-16 h-12 text-2xl">
                            <span>üí°</span>
                            <div class="custom-tooltip">Dicas</div>
                        </button>
                        <button id="encyclopedia-button" class="shop-item flex items-center justify-center p-2 rounded-lg bg-yellow-600 hover:bg-yellow-500 transition w-16 h-12 text-2xl">
                            <span>üìñ</span>
                            <div class="custom-tooltip">Enciclop√©dia</div>
                        </button>
                        <button id="save-button" class="shop-item flex items-center justify-center p-2 rounded-lg bg-indigo-500 hover:bg-indigo-400 transition w-24 h-12">
                            <span>Salvar Jogo</span>
                        </button>
                        <button id="reset-button" class="shop-item flex items-center justify-center p-2 rounded-lg bg-red-700 hover:bg-red-600 transition w-24 h-12">
                            <span>Reiniciar</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tutorial-message" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white/90 p-6 rounded-xl shadow-lg text-center max-w-sm z-40">
            <h2 class="text-2xl mb-2">Bem-vindo ao Eco-Planeta!</h2>
            <p class="mb-4">Seu trabalho √© trazer vida a este lugar. Comece clicando na nuvem para conseguir gotas de √°gua!</p>
            <button id="close-tutorial" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Entendi!</button>
        </div>
        
        <div id="how-to-play-modal" class="hidden absolute top-0 left-0 w-full h-full bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white/90 p-6 rounded-xl shadow-lg text-gray-800 max-w-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-3xl">Como Jogar</h2>
                    <button id="close-how-to-play-btn" class="text-3xl hover:text-red-600">&times;</button>
                </div>
                <div class="space-y-4 text-left">
                    <p><strong>1. Colete √Ågua (üíß):</strong> Clique na nuvem branca no topo para juntar gotas de √°gua. Este √© o seu recurso principal!</p>
                    <p><strong>2. Plante Vidas (üå≥):</strong> Use a √°gua para comprar "Mudas" e outras plantas na loja. Cada planta gera automaticamente Energia Vital (‚ú®).</p>
                    <p><strong>3. Limpe o Planeta (üåç):</strong> Use a energia para "Limpar a Polui√ß√£o". Isto n√£o s√≥ torna o seu planeta mais bonito, mas tamb√©m desbloqueia novas melhorias e animais.</p>
                    <p><strong>4. Evolua e Prospere:</strong> Compre melhorias, atraia animais, complete miss√µes e descubra todos os segredos do seu Eco-Planeta M√°gico!</p>
                    <p><strong>Dica Extra:</strong> Fique atento a eventos especiais como Estrelas Cadentes e Chuvas M√°gicas para ganhar b√≥nus incr√≠veis!</p>
                </div>
            </div>
        </div>
        
        <div id="star-seed-modal" class="hidden absolute top-0 left-0 w-full h-full bg-black/70 flex items-center justify-center z-50">
            <div class="bg-purple-100 p-8 rounded-2xl shadow-2xl text-center text-gray-800 border-8 border-purple-600 flex flex-col items-center max-w-md">
                <h2 class="text-3xl mb-4">Semente Estelar Encontrada!</h2>
                <p class="mb-4">O seu planeta atingiu o auge da sua beleza! Um cometa m√°gico deixou para tr√°s uma Semente Estelar. Plant√°-la ir√° reiniciar o seu planeta, mas dar-lhe-√° um b√≥nus permanente de +10% a toda a produ√ß√£o de energia, para sempre!</p>
                <p class="mb-6 font-bold">Voc√™ tem <span id="star-seed-modal-count">1</span> Semente(s) Estelar(es).</p>
                <div class="flex gap-4">
                    <button id="plant-star-seed-btn" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">Plantar e Recome√ßar!</button>
                    <button id="close-star-seed-btn" class="bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500">Ainda n√£o</button>
                </div>
            </div>
        </div>


        <div id="tips-modal" class="hidden absolute top-0 left-0 w-full h-full bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white/90 p-6 rounded-xl shadow-lg text-center max-w-sm text-gray-800">
                <h2 class="text-2xl mb-2">üí° Dica M√°gica üí°</h2>
                <p id="tip-text" class="mb-4 min-h-[60px]"></p>
                <div class="flex justify-center gap-4">
                     <button id="next-tip-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Outra Dica</button>
                    <button id="close-tips-btn" class="bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500">Fechar</button>
                </div>
            </div>
        </div>

        <div id="offline-progress-modal" class="hidden absolute top-0 left-0 w-full h-full bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white/90 p-6 rounded-xl shadow-lg text-center max-w-sm text-gray-800">
                <h2 class="text-2xl mb-2">Bem-vindo de volta!</h2>
                <p class="mb-4">O seu planeta continuou a prosperar enquanto voc√™ esteve fora. Voc√™ ganhou:</p>
                <div class="space-y-2 text-left mb-6 mx-auto w-fit">
                    <p class="text-lg"><span id="offline-water" class="font-bold">0</span> üíß √Ågua</p>
                    <p class="text-lg"><span id="offline-energy" class="font-bold">0</span> ‚ú® Energia</p>
                </div>
                <button id="collect-offline-btn" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600">Coletar!</button>
            </div>
        </div>

        <div id="reset-confirmation-modal" class="hidden absolute top-0 left-0 w-full h-full bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white/90 p-6 rounded-xl shadow-lg text-center max-w-sm text-gray-800">
                <h2 class="text-2xl mb-2">Tem certeza?</h2>
                <p class="mb-4">Todo o seu progresso ser√° perdido para sempre. Deseja reiniciar o jogo?</p>
                <div class="flex justify-center gap-4">
                    <button id="confirm-reset-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Confirmar</button>
                    <button id="cancel-reset-btn" class="bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500">Cancelar</button>
                </div>
            </div>
        </div>

         <div id="encyclopedia-modal" class="hidden absolute top-0 left-0 w-full h-full bg-black/50 flex items-center justify-center z-40">
            <div class="bg-yellow-50/95 p-6 rounded-xl shadow-2xl max-w-3xl w-full text-gray-800 border-4 border-yellow-600">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-3xl">Enciclop√©dia M√°gica</h2>
                    <button id="close-encyclopedia-btn" class="text-3xl hover:text-red-600">&times;</button>
                </div>
                <div id="encyclopedia-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 max-h-[60vh] overflow-y-auto pr-2">
                    </div>
            </div>
        </div>

         <div id="missions-modal" class="hidden absolute top-0 left-0 w-full h-full bg-black/50 flex items-center justify-center z-50">
            <div class="bg-yellow-50/95 p-6 rounded-xl shadow-2xl max-w-lg w-full text-gray-800 border-4 border-yellow-800">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-3xl">Livro de Miss√µes</h2>
                    <button id="close-missions-btn" class="text-3xl hover:text-red-600">&times;</button>
                </div>
                <div id="missions-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // --- Elementos da DOM ---
        const mainMenuEl = document.getElementById('main-menu');
        const startGameBtn = document.getElementById('start-game-btn');
        const gameContainerEl = document.getElementById('game-container');
        const waterCountEl = document.getElementById('water-count');
        const energyCountEl = document.getElementById('energy-count');
        const energyPerSecondEl = document.getElementById('energy-per-second');
        const cloudEl = document.getElementById('cloud');
        const planetEl = document.getElementById('planet');
        
        const buySaplingBtn = document.getElementById('buy-sapling');
        const buyFlowerBtn = document.getElementById('buy-flower');
        const cleanupBtn = document.getElementById('cleanup-button');
        const upgradeClickBtn = document.getElementById('upgrade-click');
        const upgradeAutoBtn = document.getElementById('upgrade-auto');
        const animalShopEl = document.getElementById('animal-shop');
        const buyBeeBtn = document.getElementById('buy-bee');
        const buySquirrelBtn = document.getElementById('buy-squirrel');
        const saveBtn = document.getElementById('save-button');
        const resetBtn = document.getElementById('reset-button');

        const saplingCostEl = document.getElementById('sapling-cost');
        const flowerCostEl = document.getElementById('flower-cost');
        const cleanupCostEl = document.getElementById('cleanup-cost');
        const clickUpgradeCostEl = document.getElementById('click-upgrade-cost');
        const autoUpgradeCostEl = document.getElementById('auto-upgrade-cost');
        const clickUpgradeBonusEl = document.getElementById('click-upgrade-bonus');
        const autoUpgradeBonusEl = document.getElementById('auto-upgrade-bonus');
        const beeCostEl = document.getElementById('bee-cost');
        const squirrelCostEl = document.getElementById('squirrel-cost');
        
        const flowerHintEl = document.getElementById('flower-hint');
        const cleanupHintEl = document.getElementById('cleanup-hint');
        const beeHintEl = document.getElementById('bee-hint');
        const squirrelHintEl = document.getElementById('squirrel-hint');
        const autoHintEl = document.getElementById('auto-hint');

        const tutorialMessage = document.getElementById('tutorial-message');
        const closeTutorialBtn = document.getElementById('close-tutorial');
        const resetModal = document.getElementById('reset-confirmation-modal');
        const confirmResetBtn = document.getElementById('confirm-reset-btn');
        const cancelResetBtn = document.getElementById('cancel-reset-btn');
        
        const sunEl = document.getElementById('sun');
        const moonEl = document.getElementById('moon');
        const starsContainerEl = document.getElementById('stars-container');

        const notificationAreaEl = document.getElementById('notification-area');
        const eventElementsContainerEl = document.getElementById('event-elements-container');

        const encyclopediaBtn = document.getElementById('encyclopedia-button');
        const encyclopediaModal = document.getElementById('encyclopedia-modal');
        const closeEncyclopediaBtn = document.getElementById('close-encyclopedia-btn');
        const encyclopediaGridEl = document.getElementById('encyclopedia-grid');

        const tipsBtn = document.getElementById('tips-button');
        const howToPlayBtn = document.getElementById('how-to-play-button');
        const howToPlayModal = document.getElementById('how-to-play-modal');
        const closeHowToPlayBtn = document.getElementById('close-how-to-play-btn');

        const tipsModal = document.getElementById('tips-modal');
        const tipTextEl = document.getElementById('tip-text');
        const nextTipBtn = document.getElementById('next-tip-btn');
        const closeTipsBtn = document.getElementById('close-tips-btn');
        
        const bonusSection = document.getElementById('bonus-section');
        const autoclickBonusBtn = document.getElementById('autoclick-bonus-btn');
        const energyBonusBtn = document.getElementById('energy-bonus-btn');
        const growthBonusBtn = document.getElementById('growth-bonus-btn');

        const missionsBtn = document.getElementById('missions-button');
        const missionsModal = document.getElementById('missions-modal');
        const closeMissionsBtn = document.getElementById('close-missions-btn');
        const missionsListEl = document.getElementById('missions-list');
        
        const specialEventsContainer = document.getElementById('special-events-container');
        
        const starSeedDisplay = document.getElementById('star-seed-display');
        const starSeedCountEl = document.getElementById('star-seed-count');
        const starSeedModal = document.getElementById('star-seed-modal');
        const plantStarSeedBtn = document.getElementById('plant-star-seed-btn');
        const closeStarSeedBtn = document.getElementById('close-star-seed-btn');
        const starSeedModalCountEl = document.getElementById('star-seed-modal-count');

        // --- Estado do Jogo ---
        let gameState = {
            water: 0, energy: 0, clickPower: 1, autoWaterPerSecond: 0, energyPerSecond: 0,
            plants: [], animals: [], pollutionCleaned: 0,
            costs: { sapling: 10, flower: 50, cleanup: 100, clickUpgrade: 25, autoUpgrade: 200, bee: 500, squirrel: 1000 },
            upgrades: { click: 0, auto: 0 },
            bonuses: { autoClickers: 0, energyBursts: 0, superGrowths: 0, ecoFrenzies: 0 },
            activeBonuses: { 
                autoClicker: { active: false, timeLeft: 0 },
                superGrowth: { active: false, timeLeft: 0 },
                ecoFrenzy: { active: false, timeLeft: 0}
            },
            activeEvent: null,
            weatherEvent: null,
            lastSaveTime: null,
            completedMissions: [],
            gameTime: 0,
            starSeeds: 0,
            cometOffered: false,
            unlockedEntries: { sapling: false, adultTree: false, flower: false, cosmicFlower: false, cleanup: false, bee: false, squirrel: false, pollutionEvent: false, rainEvent: false, grass: false, river: false, mountains: false }
        };

        // --- Dados da Enciclop√©dia ---
        const encyclopediaData = {
            sapling: { name: 'Muda', icon: 'üå≥', text: 'As √°rvores s√£o os pulm√µes do planeta! Elas limpam o ar que respiramos, absorvendo di√≥xido de carbono e libertando oxig√©nio.' },
            adultTree: { name: '√Årvore Adulta', icon: 'üå≤', text: 'Uma √°rvore adulta d√° sombra, √© a casa de muitos animais e produz muito mais oxig√©nio do que uma muda pequena. A paci√™ncia √© recompensada!' },
            flower: { name: 'Flor', icon: 'üåª', text: 'As flores n√£o s√£o apenas bonitas, elas alimentam muitos animais, como as abelhas e os p√°ssaros, com o seu n√©ctar doce.' },
            cosmicFlower: { name: 'Flor C√≥smica', icon: 'üå†', text: 'Nascida da poeira estelar, esta flor rara gera uma quantidade imensa de energia pura, um verdadeiro tesouro para qualquer ecossistema.' },
            cleanup: { name: 'Planeta Limpo', icon: 'üåç', text: 'Cuidar do nosso planeta, limpando-o e n√£o o poluindo, ajuda a manter as plantas, os animais e a n√≥s mesmos saud√°veis e felizes.' },
            bee: { name: 'Abelha', icon: 'üêù', text: 'As abelhas s√£o essenciais! Ao visitarem as flores, elas fazem a poliniza√ß√£o, que ajuda as plantas a produzir frutos e sementes.' },
            squirrel: { name: 'Esquilo', icon: 'üêøÔ∏è', text: 'Os esquilos s√£o √≥timos jardineiros! Eles enterram nozes e sementes para comer mais tarde, mas muitas vezes esquecem-se, e novas √°rvores crescem nesses locais.' },
            pollutionEvent: { name: 'Nuvem de Polui√ß√£o', icon: '‚òÅÔ∏è', text: 'A polui√ß√£o do ar pode prejudicar a nossa sa√∫de e a das plantas. √â por isso que √© importante manter o ar limpo, usando menos carros e mais bicicletas!' },
            rainEvent: { name: 'Chuva M√°gica', icon: 'üåßÔ∏è', text: 'A chuva √© essencial para a vida! Ela rega as plantas, enche os rios e lagos, e garante que todos os seres vivos tenham √°gua para beber.' },
            grass: { name: 'Pradaria Verdejante', icon: 'üå±', text: 'A relva ajuda a prevenir a eros√£o do solo, mant√©m o planeta fresco e √© a casa de muitos pequenos insetos!' },
            river: { name: 'Rio da Vida', icon: 'üèûÔ∏è', text: 'Os rios s√£o como as veias do planeta, levando √°gua fresca e nutrientes para todas as plantas e animais ao seu redor.' },
            mountains: { name: 'Montanhas Majestosas', icon: '‚õ∞Ô∏è', text: 'As montanhas influenciam o clima e criam habitats √∫nicos. A neve no seu topo derrete e fornece √°gua vital durante as esta√ß√µes mais secas.' }
        };
        
        const tips = [
            "Plantar mais mudas √© a forma mais r√°pida de aumentar a sua energia no in√≠cio!",
            "N√£o se esque√ßa de melhorar a sua Nuvem para coletar √°gua mais rapidamente.",
            "Limpar o planeta desbloqueia novas melhorias e atrai animais!",
            "Os esquilos podem encontrar tesouros de √°gua b√≥nus. Vale a pena o investimento!",
            "Fique de olho em eventos inesperados! Resolv√™-los rapidamente pode salvar os seus recursos.",
            "Cada nova descoberta adiciona uma p√°gina √† sua Enciclop√©dia. Tente completar todas!"
        ];
        let currentTipIndex = 0;

        // --- Ciclo Dia/Noite ---
        let fineGameTime = 0; // Milissegundos, para anima√ß√µes suaves
        const DAY_DURATION_SECONDS = 180; // 3 minutos
        const NIGHT_DURATION_SECONDS = 180; // 3 minutos
        let isNight = false;

        // --- Drag and Drop State ---
        let draggedItem = {
            element: null, type: null, index: -1, newAngle: 0, newDistance: 0
        };

        // --- Fun√ß√µes Principais do Jogo ---
        function loadGame() {
            const savedState = localStorage.getItem('ecoPlanetaSave');
            if (savedState) {
                const loadedState = JSON.parse(savedState);
                const preservedStarSeeds = loadedState.starSeeds || 0;
                const preservedMissions = loadedState.completedMissions || [];

                gameState = {...gameState, ...loadedState, activeEvent: null, weatherEvent: null, activeBonuses: { autoClicker: { active: false, timeLeft: 0 }, superGrowth: { active: false, timeLeft: 0}, ecoFrenzy: {active: false, timeLeft: 0} } };
                gameState.starSeeds = preservedStarSeeds;
                gameState.completedMissions = preservedMissions;

                gameState.costs = {...gameState.costs, ...(loadedState.costs || {})};
                gameState.upgrades = {...gameState.upgrades, ...(loadedState.upgrades || {})};
                gameState.bonuses = {...gameState.bonuses, ...(loadedState.bonuses || {})};
                gameState.unlockedEntries = {...gameState.unlockedEntries, ...(loadedState.unlockedEntries || {})};
                tutorialMessage.style.display = 'none';
                fineGameTime = (loadedState.gameTime || 0) * 1000;
                
                const autoUpgrades = gameState.upgrades.auto || 0;
                gameState.autoWaterPerSecond = (autoUpgrades * (autoUpgrades + 1)) / 2;
            }
            calculateOfflineProgress();
            renderAll();
            checkMissions();
        }

        function saveGame() {
            gameState.lastSaveTime = Date.now();
            gameState.gameTime = Math.floor(fineGameTime / 1000);
            localStorage.setItem('ecoPlanetaSave', JSON.stringify(gameState));
        }

        function calculateOfflineProgress() {
            if (!gameState.lastSaveTime || gameState.autoWaterPerSecond === 0 && gameState.energyPerSecond === 0) return;
            const now = Date.now();
            let timeDiffSeconds = Math.floor((now - gameState.lastSaveTime) / 1000);
            if (timeDiffSeconds <= 5) return;
            const MAX_OFFLINE_SECONDS = 2 * 60 * 60;
            const effectiveTime = Math.min(timeDiffSeconds, MAX_OFFLINE_SECONDS);
            const waterGained = effectiveTime * gameState.autoWaterPerSecond;
            const energyGained = effectiveTime * (gameState.energyPerSecond * (1 + gameState.starSeeds * 0.1));

            if (waterGained > 0 || energyGained > 0) {
                gameState.water += waterGained;
                gameState.energy += energyGained;
                document.getElementById('offline-water').textContent = Math.floor(waterGained).toLocaleString();
                document.getElementById('offline-energy').textContent = Math.floor(energyGained).toLocaleString();
                const modal = document.getElementById('offline-progress-modal');
                modal.classList.remove('hidden');
                document.getElementById('collect-offline-btn').onclick = () => {
                    modal.classList.add('hidden');
                    updateDisplay();
                };
            }
        }
        
        // --- Event Listeners ---
        startGameBtn.addEventListener('click', () => {
            mainMenuEl.classList.add('menu-hiding');
            setTimeout(() => {
                mainMenuEl.style.display = 'none';
            }, 700); // Corresponde √† dura√ß√£o da anima√ß√£o
        });

        planetEl.addEventListener('mousedown', startDrag);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', endDrag);
        planetEl.addEventListener('touchstart', startDrag, { passive: false });
        document.addEventListener('touchmove', drag, { passive: false });
        document.addEventListener('touchend', endDrag);

        cloudEl.addEventListener('click', () => {
            if (draggedItem.element) return;
            collectWater(gameState.clickPower);
            if (tutorialMessage.style.display !== 'none') {
                tutorialMessage.style.display = 'none';
            }
        });

        function collectWater(amount) {
            let waterOnClick = amount;
            if (gameState.weatherEvent && gameState.weatherEvent.type === 'rain') {
                waterOnClick *= 2;
            }
            gameState.water += waterOnClick;
            updateDisplay();
            spawnFallingDrop();
        }

        buySaplingBtn.addEventListener('click', () => buyPlant('sapling', 1));
        buyFlowerBtn.addEventListener('click', () => buyPlant('flower', 5));
        buyBeeBtn.addEventListener('click', () => buyAnimal('bee', 10));
        buySquirrelBtn.addEventListener('click', () => buyAnimal('squirrel', 0));
        cleanupBtn.addEventListener('click', cleanupPollution);
        upgradeClickBtn.addEventListener('click', upgradeClick);
        upgradeAutoBtn.addEventListener('click', upgradeAuto);
        
        saveBtn.addEventListener('click', () => {
            saveGame();
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<span>Salvo! ‚úÖ</span>';
            saveBtn.disabled = true;
            setTimeout(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }, 1500);
        });

        resetBtn.addEventListener('click', () => {
            resetModal.classList.remove('hidden');
        });
        cancelResetBtn.addEventListener('click', () => {
            resetModal.classList.add('hidden');
        });
        confirmResetBtn.addEventListener('click', () => {
            localStorage.removeItem('ecoPlanetaSave');
            location.reload();
        });
        
        encyclopediaBtn.addEventListener('click', () => {
            encyclopediaBtn.classList.remove('reward-ready');
            renderEncyclopedia();
            encyclopediaModal.classList.remove('hidden');
        });
        closeEncyclopediaBtn.addEventListener('click', () => {
            encyclopediaModal.classList.add('hidden');
        });
        
        tipsBtn.addEventListener('click', () => {
            currentTipIndex = Math.floor(Math.random() * tips.length);
            tipTextEl.textContent = tips[currentTipIndex];
            tipsModal.classList.remove('hidden');
        });
        nextTipBtn.addEventListener('click', () => {
            currentTipIndex = (currentTipIndex + 1) % tips.length;
            tipTextEl.textContent = tips[currentTipIndex];
        });
        closeTipsBtn.addEventListener('click', () => {
            tipsModal.classList.add('hidden');
        });
        
        howToPlayBtn.addEventListener('click', () => {
            howToPlayModal.classList.remove('hidden');
        });
        closeHowToPlayBtn.addEventListener('click', () => {
            howToPlayModal.classList.add('hidden');
        });
        
        missionsBtn.addEventListener('click', () => {
            renderMissions();
            missionsModal.classList.remove('hidden');
        });
        closeMissionsBtn.addEventListener('click', () => {
            missionsModal.classList.add('hidden');
        });
        
        autoclickBonusBtn.addEventListener('click', () => {
            if(gameState.bonuses.autoClickers > 0 && !gameState.activeBonuses.autoClicker.active) {
                gameState.bonuses.autoClickers--;
                gameState.activeBonuses.autoClicker = { active: true, timeLeft: 30 };
                updateBonusUI();
            }
        });
        energyBonusBtn.addEventListener('click', () => {
             if(gameState.bonuses.energyBursts > 0) {
                gameState.bonuses.energyBursts--;
                const energyGained = (gameState.energyPerSecond * 60) + 100; // 1 min of production + 100
                gameState.energy += energyGained;
                showNotification(`BOOM! +${Math.floor(energyGained)}‚ú® energia!`, 'discovery');
                updateBonusUI();
            }
        });
        growthBonusBtn.addEventListener('click', () => {
             if(gameState.bonuses.superGrowths > 0 && !gameState.activeBonuses.superGrowth.active) {
                gameState.bonuses.superGrowths--;
                gameState.activeBonuses.superGrowth = { active: true, timeLeft: 60 };
                showNotification(`Super Crescimento ativado por 60s!`, 'discovery');
                updateBonusUI();
            }
        });

        plantStarSeedBtn.addEventListener('click', () => {
            if (gameState.starSeeds > 0) {
                const preservedSeeds = gameState.starSeeds;
                const preservedMissions = gameState.completedMissions;
                // Reset to default state
                const defaultState = {
                    water: 0, energy: 0, clickPower: 1, autoWaterPerSecond: 0, energyPerSecond: 0,
                    plants: [], animals: [], pollutionCleaned: 0,
                    costs: { sapling: 10, flower: 50, cleanup: 100, clickUpgrade: 25, autoUpgrade: 200, bee: 500, squirrel: 1000 },
                    upgrades: { click: 0, auto: 0 },
                    bonuses: { autoClickers: 0, energyBursts: 0, superGrowths: 0 },
                    activeBonuses: { autoClicker: { active: false, timeLeft: 0 }, superGrowth: { active: false, timeLeft: 0 }, ecoFrenzy: { active: false, timeLeft: 0 } },
                    activeEvent: null, weatherEvent: null, lastSaveTime: Date.now(),
                    gameTime: 0, isPausedForRoulette: false, cometOffered: false,
                    unlockedEntries: { sapling: false, adultTree: false, flower: false, cosmicFlower: false, cleanup: false, bee: false, squirrel: false, pollutionEvent: false, rainEvent: false, grass: false, river: false, mountains: false },
                    starSeeds: preservedSeeds,
                    completedMissions: preservedMissions,
                };
                 gameState = defaultState;
                 fineGameTime = 0;
                 saveGame();
                 location.reload();
            }
        });

        closeStarSeedBtn.addEventListener('click', () => starSeedModal.classList.add('hidden'));


        // --- L√≥gica de Compra e A√ß√µes ---
        function buyPlant(type, energyBonus) {
            if (gameState.water >= gameState.costs[type]) {
                gameState.water -= gameState.costs[type];
                gameState.energyPerSecond += energyBonus;
                gameState.costs[type] = Math.ceil(gameState.costs[type] * 1.2);
                const data = { type, age: 0, position: { angle: Math.random() * 360, distance: Math.random() * 80 + 20 } };
                gameState.plants.push(data);
                unlockEntry(type);
                renderAll(true);
            }
        }
        
        function buyAnimal(type, energyBonus) {
            if (gameState.energy >= gameState.costs[type]) {
                gameState.energy -= gameState.costs[type];
                gameState.energyPerSecond += energyBonus;
                gameState.costs[type] = Math.ceil(gameState.costs[type] * 1.8);
                const data = { type, position: { angle: Math.random() * 360, distance: Math.random() * 80 + 20 } };
                gameState.animals.push(data);
                unlockEntry(type);
                renderAll(true);
            }
        }

        function cleanupPollution() {
            if (gameState.energy >= gameState.costs.cleanup) {
                gameState.energy -= gameState.costs.cleanup;
                gameState.pollutionCleaned++;
                
                // --- ALTERA√á√ÉO APLICADA AQUI ---
                // Se o jogador limpou 5 ou mais vezes, o custo para a pr√≥xima limpeza aumenta mais devagar.
                const costMultiplier = gameState.pollutionCleaned >= 5 ? 1.8 : 2.5;
                gameState.costs.cleanup = Math.ceil(gameState.costs.cleanup * costMultiplier);
                
                unlockEntry('cleanup');
                if (gameState.pollutionCleaned >= 2) unlockEntry('grass');
                if (gameState.pollutionCleaned >= 5) unlockEntry('river');
                if (gameState.pollutionCleaned >= 10) unlockEntry('mountains');

                updateDisplay();
            }
        }
        function upgradeClick() {
            if (gameState.water >= gameState.costs.clickUpgrade) {
                gameState.water -= gameState.costs.clickUpgrade;
                gameState.upgrades.click++;
                gameState.clickPower = 1 + gameState.upgrades.click;
                gameState.costs.clickUpgrade = Math.ceil(gameState.costs.clickUpgrade * 1.5);
                updateDisplay();
            }
        }
        function upgradeAuto() {
             if (gameState.energy >= gameState.costs.autoUpgrade) {
                gameState.energy -= gameState.costs.autoUpgrade;
                gameState.upgrades.auto++;
                gameState.autoWaterPerSecond += gameState.upgrades.auto;
                gameState.costs.autoUpgrade = Math.ceil(gameState.costs.autoUpgrade * 2.2);
                updateDisplay();
            }
        }
        
        // --- Drag and Drop Functions ---
        function getEventCoords(e) { return e.touches ? e.touches[0] : e; }
        function startDrag(e) {
            if (e.target.closest('.planet-item')) {
                const target = e.target.closest('.planet-item'); e.preventDefault();
                draggedItem.element = target; draggedItem.type = target.dataset.type; draggedItem.index = parseInt(target.dataset.index);
                document.body.style.cursor = 'grabbing'; draggedItem.element.style.zIndex = '100'; draggedItem.element.style.transition = 'none';
            }
        }
        function drag(e) {
            if (!draggedItem.element) return;
            e.preventDefault();
            const coords = getEventCoords(e); const planetRect = planetEl.getBoundingClientRect();
            const planetCenterX = planetRect.left + planetRect.width / 2; const planetCenterY = planetRect.top + planetRect.height / 2;
            const dx = coords.clientX - planetCenterX; const dy = coords.clientY - planetCenterY;
            let newAngle = Math.atan2(dy, dx) * (180 / Math.PI) + 90; const distancePixels = Math.sqrt(dx*dx + dy*dy);
            let newDistance = (distancePixels / (planetRect.width / 2)) * 100;
            newDistance = Math.max(20, Math.min(newDistance, 100));
            draggedItem.element.style.transform = `rotate(${newAngle}deg) translateY(-${newDistance}%) rotate(-${newAngle}deg)`;
            draggedItem.newAngle = newAngle; draggedItem.newDistance = newDistance;
        }
        function endDrag() {
            if (!draggedItem.element) return;
            if (draggedItem.type && draggedItem.index > -1) {
                const itemArray = (draggedItem.type === 'plant') ? gameState.plants : gameState.animals;
                const itemData = itemArray[draggedItem.index];
                if (itemData) {
                    itemData.position.angle = draggedItem.newAngle;
                    itemData.position.distance = draggedItem.newDistance;
                }
            }
            document.body.style.cursor = 'default';
            draggedItem.element.style.zIndex = '10';
            draggedItem.element.style.transition = 'transform 0.2s ease-in-out';
            draggedItem = { element: null, type: null, index: -1, newAngle: 0, newDistance: 0 };
        }

        // --- Fun√ß√µes de Renderiza√ß√£o e UI ---
        function updateDisplay() {
            waterCountEl.textContent = Math.floor(gameState.water);
            energyCountEl.textContent = Math.floor(gameState.energy);
            
            const starSeedBonus = 1 + (gameState.starSeeds * 0.1);
            let effectiveEnergyPerSecond = gameState.energyPerSecond * starSeedBonus;
            
            if(gameState.activeEvent && gameState.activeEvent.type === 'pollution') {
                effectiveEnergyPerSecond *= 0.5;
            }
            energyPerSecondEl.textContent = effectiveEnergyPerSecond.toFixed(1);

            if(gameState.starSeeds > 0) {
                starSeedDisplay.classList.remove('hidden');
                starSeedDisplay.classList.add('flex');
                starSeedCountEl.textContent = gameState.starSeeds;
            }

            saplingCostEl.textContent = gameState.costs.sapling;
            flowerCostEl.textContent = gameState.costs.flower;
            cleanupCostEl.textContent = gameState.costs.cleanup;
            clickUpgradeCostEl.textContent = gameState.costs.clickUpgrade;
            autoUpgradeCostEl.textContent = gameState.costs.autoUpgrade;
            autoUpgradeBonusEl.textContent = gameState.upgrades.auto + 1;
            beeCostEl.textContent = gameState.costs.bee;
            squirrelCostEl.textContent = gameState.costs.squirrel;
            clickUpgradeBonusEl.textContent = gameState.upgrades.click + 1;
            buySaplingBtn.disabled = gameState.water < gameState.costs.sapling;
            upgradeClickBtn.disabled = gameState.water < gameState.costs.clickUpgrade;
            const canBuyFlower = gameState.energyPerSecond >= 10;
            buyFlowerBtn.disabled = !canBuyFlower || gameState.water < gameState.costs.flower;
            flowerHintEl.style.display = canBuyFlower ? 'none' : 'block';
            const canCleanup = gameState.energyPerSecond >= 20;
            cleanupBtn.disabled = !canCleanup || gameState.energy < gameState.costs.cleanup;
            cleanupHintEl.style.display = canCleanup ? 'none' : 'block';
            const canBuyAuto = gameState.pollutionCleaned >= 1;
            upgradeAutoBtn.disabled = !canBuyAuto || gameState.energy < gameState.costs.autoUpgrade;
            autoHintEl.style.display = canBuyAuto ? 'none' : 'block';
            const canSeeAnimals = gameState.pollutionCleaned >= 2;
            if (canSeeAnimals) { animalShopEl.classList.remove('hidden'); animalShopEl.classList.add('flex'); }
            buyBeeBtn.disabled = !canSeeAnimals || gameState.energy < gameState.costs.bee;
            beeHintEl.style.display = canSeeAnimals ? 'none' : 'block';
            const hasBee = gameState.animals.some(animal => animal.type === 'bee');
            buySquirrelBtn.disabled = !hasBee || gameState.energy < gameState.costs.squirrel;
            squirrelHintEl.style.display = hasBee ? 'none' : 'block';
            updatePlanetLook();
            updateBonusUI();
            checkMissions();
        }
        
        function updatePlanetLook() {
            const groundLayerEl = document.getElementById('ground-layer');
            const grassLayerEl = document.getElementById('grass-layer');
            const riverLayerEl = document.getElementById('river-layer');
            const mountainLayerEl = document.getElementById('mountain-layer');
            if (groundLayerEl) {
                const circle = groundLayerEl.querySelector('circle');
                if (gameState.pollutionCleaned === 0) { circle.setAttribute('fill', '#5c4033'); } 
                else if (gameState.pollutionCleaned === 1) { circle.setAttribute('fill', '#8B4513'); }
            }
            if(grassLayerEl) grassLayerEl.style.opacity = gameState.pollutionCleaned >= 2 ? '1' : '0';
            if(riverLayerEl) riverLayerEl.style.opacity = gameState.pollutionCleaned >= 5 ? '1' : '0';
            if(mountainLayerEl) mountainLayerEl.style.opacity = gameState.pollutionCleaned >= 10 ? '1' : '0';

            if (gameState.pollutionCleaned >= 10 && !gameState.cometOffered) {
                triggerComet();
                gameState.cometOffered = true;
            }
        }
        
        function renderAll(isNewItem = false) {
            const oldItems = planetEl.querySelectorAll('.planet-item');
            oldItems.forEach(item => item.remove());
            const itemsToRender = [...gameState.plants, ...gameState.animals];
            itemsToRender.forEach((data, index) => {
                const isPlant = index < gameState.plants.length;
                const itemType = isPlant ? 'plant' : 'animal';
                const itemIndex = isPlant ? index : index - gameState.plants.length;
                
                let element = createElement(data, itemType, itemIndex);
                if (element) {
                    if (isNewItem && index === itemsToRender.length - 1) {
                        element.classList.add('spawn-animation');
                    }
                    planetEl.appendChild(element);
                }
            });
            updateDisplay();
        }

        function createElement(data, type, index) {
            let innerHTML = ''; let fontSize = ''; let itemType = data.type;
            switch(data.type) {
                case 'sapling': innerHTML = 'üå≥'; fontSize = '2rem'; break;
                case 'adultTree': innerHTML = 'üå≤'; fontSize = '3rem'; break;
                case 'flower': innerHTML = 'üåª'; fontSize = '1.75rem'; break;
                case 'cosmicFlower': innerHTML = 'üå†'; fontSize = '2.5rem'; break;
                case 'bee': innerHTML = 'üêù'; fontSize = '1.5rem'; break;
                case 'squirrel': innerHTML = 'üêøÔ∏è'; fontSize = '1.75rem'; break;
                default: return null;
            }
            const e = document.createElement('div');
            e.className = 'planet-item clickable'; e.dataset.itemType = itemType;
            e.innerHTML = `<span>${innerHTML}</span>`; e.style.fontSize = fontSize;
            e.style.transform = `rotate(${data.position.angle}deg) translateY(-${data.position.distance}%) rotate(-${data.position.angle}deg)`;
            e.dataset.type = type; e.dataset.index = index;
            return e;
        }

        function spawnFallingDrop() { const e = document.createElement('div'); e.innerHTML = 'üíß'; e.className = 'falling-drop text-3xl'; e.style.left = `${Math.random()*80+10}%`; cloudEl.appendChild(e); setTimeout(()=>e.remove(),1000); }
        function spawnFloatingText(text, colorClass) { const e=document.createElement('div');e.textContent=text;e.className=`floating-text ${colorClass}`;const a=Math.random()*Math.PI+Math.PI,r=150;e.style.left=`calc(50% + ${Math.cos(a)*r}px)`;e.style.top=`calc(50% + ${Math.sin(a)*r}px)`;gameContainerEl.appendChild(e);setTimeout(()=>e.remove(),1500);}
        function spawnEnergyParticle(sourceElement) {
            if (!sourceElement) return;
            const particle = document.createElement('div'); particle.innerHTML = '‚ú®'; particle.className = 'energy-particle';
            const rect = sourceElement.getBoundingClientRect(); const gameRect = gameContainerEl.getBoundingClientRect();
            particle.style.left = `${rect.left - gameRect.left + (rect.width / 2) - 8}px`; particle.style.top = `${rect.top - gameRect.top + (rect.height / 2) - 8}px`;
            gameContainerEl.appendChild(particle); setTimeout(() => { particle.remove(); }, 2000);
        }

        function showNotification(message, type = 'info', isSticky = false) {
            const notification = document.createElement('div');
            let bgColor = 'bg-sky-500/90';
            if (type === 'discovery') bgColor = 'bg-green-600/90'; if (type === 'event-start') bgColor = 'bg-red-800/90';
            if (type === 'event-good') bgColor = 'bg-green-500/90'; if (type === 'event-bad') bgColor = 'bg-yellow-700/90';
            notification.className = `p-3 rounded-lg shadow-lg text-white text-sm max-w-xs ${bgColor}`; notification.innerHTML = `<p>${message}</p>`;
            if (isSticky) {
                notification.id = 'active-event-notification'; notification.style.animation = 'slide-in-down 0.5s ease-out forwards';
                 const timerBar = document.createElement('div'); timerBar.className = 'w-full bg-gray-200/50 rounded-full h-1.5 mt-2';
                timerBar.innerHTML = `<div id="event-timer-progress-toast" class="bg-yellow-400 h-1.5 rounded-full transition-all duration-1000 ease-linear" style="width: 100%"></div>`;
                notification.appendChild(timerBar);
            } else {
                notification.classList.add('toast-notification');
                notification.addEventListener('animationend', (e) => { if (e.animationName === 'fade-out-up') { notification.remove(); } });
            }
            notificationAreaEl.appendChild(notification);
        }

        function updateBonusUI() {
            const hasBonuses = gameState.bonuses.autoClickers > 0 || gameState.bonuses.energyBursts > 0 || gameState.bonuses.superGrowths > 0 || gameState.bonuses.ecoFrenzies > 0;
            if (hasBonuses) { bonusSection.classList.remove('hidden'); bonusSection.classList.add('flex'); } else { bonusSection.classList.add('hidden'); }
            
            const autoClickBadge = autoclickBonusBtn.querySelector('.badge');
            autoclickBonusBtn.disabled = gameState.bonuses.autoClickers === 0 || gameState.activeBonuses.autoClicker.active;
            if (gameState.bonuses.autoClickers > 0) { autoClickBadge.textContent = gameState.bonuses.autoClickers; autoClickBadge.classList.remove('hidden'); } else { autoClickBadge.classList.add('hidden'); }
            
            const energyBadge = energyBonusBtn.querySelector('.badge');
            energyBonusBtn.disabled = gameState.bonuses.energyBursts === 0;
            if (gameState.bonuses.energyBursts > 0) { energyBadge.textContent = gameState.bonuses.energyBursts; energyBadge.classList.remove('hidden'); } else { energyBadge.classList.add('hidden'); }

            const growthBadge = growthBonusBtn.querySelector('.badge');
            growthBonusBtn.disabled = gameState.bonuses.superGrowths === 0 || gameState.activeBonuses.superGrowth.active;
            if (gameState.bonuses.superGrowths > 0) { growthBadge.textContent = gameState.bonuses.superGrowths; growthBadge.classList.remove('hidden'); } else { growthBadge.classList.add('hidden'); }
        }

        function unlockEntry(entryKey) {
            if (!gameState.unlockedEntries[entryKey]) {
                gameState.unlockedEntries[entryKey] = true;
                showNotification(`Nova descoberta: ${encyclopediaData[entryKey].name}! üìñ`, 'discovery');
                encyclopediaBtn.classList.add('reward-ready');
            }
        }
        function renderEncyclopedia() {
            encyclopediaGridEl.innerHTML = '';
            for (const key in encyclopediaData) {
                const entry = encyclopediaData[key]; const isUnlocked = gameState.unlockedEntries[key];
                const entryEl = document.createElement('div');
                entryEl.className = `encyclopedia-entry p-4 rounded-lg bg-white/50 border-2 border-yellow-700/50 ${!isUnlocked ? 'locked' : ''}`;
                entryEl.innerHTML = isUnlocked ? `<div class="text-4xl mb-2">${entry.icon}</div><h4 class="text-xl font-bold">${entry.name}</h4><p class="text-sm mt-2">${entry.text}</p>` : `<div class="text-4xl mb-2">‚ùì</div><h4 class="text-xl font-bold">Desconhecido</h4>`;
                encyclopediaGridEl.appendChild(entryEl);
            }
        }

        function updateDayNightCycle() {
            const cycleTotalTime = DAY_DURATION_SECONDS + NIGHT_DURATION_SECONDS;
            const timeInCycle = (fineGameTime / 1000) % cycleTotalTime;
            
            if (timeInCycle < DAY_DURATION_SECONDS) { // Dia
                if(isNight) {
                    isNight = false; document.body.style.backgroundColor = ''; sunEl.style.opacity = '1'; moonEl.style.opacity = '0'; removeStars();
                    triggerShootingStar();
                }
                const dayProgress = timeInCycle / DAY_DURATION_SECONDS;
                const sunAngle = dayProgress * Math.PI;
                const sunX = (window.innerWidth + sunEl.offsetWidth + 100) * dayProgress - (sunEl.offsetWidth + 50);
                const sunY = (window.innerHeight / 2.5) * Math.sin(sunAngle);
                sunEl.style.transform = `translate(${sunX}px, ${-sunY}px)`;
            } else { // Noite
                if(!isNight) {
                     isNight = true; document.body.style.backgroundColor = '#0c1425'; sunEl.style.opacity = '0'; moonEl.style.opacity = '1'; createStars(50);
                }
                const nightProgress = (timeInCycle - DAY_DURATION_SECONDS) / NIGHT_DURATION_SECONDS;
                const moonAngle = nightProgress * Math.PI;
                const moonX = (window.innerWidth + moonEl.offsetWidth + 100) * nightProgress - (moonEl.offsetWidth + 50);
                const moonY = (window.innerHeight / 3) * Math.sin(moonAngle);
                moonEl.style.transform = `translate(${moonX}px, ${-moonY}px)`;
            }
        }
        function createStars(count) {
            removeStars();
            for (let i = 0; i < count; i++) {
                const star = document.createElement('div'); const size = Math.random() * 2 + 1; star.classList.add('star'); star.style.width = `${size}px`; star.style.height = `${size}px`; star.style.top = `${Math.random() * 100}%`; star.style.left = `${Math.random() * 100}%`; star.style.animationDelay = `${Math.random() * 2}s`; starsContainerEl.appendChild(star);
            }
        }
        function removeStars() { starsContainerEl.innerHTML = ''; }
        
        function triggerSpecialDrop() {
            const roll = Math.random();
            if (roll < 0.15) { // 15% de chance para um b√≥nus
                const bonusRoll = Math.random();
                if (bonusRoll < 0.33) {
                    gameState.bonuses.autoClickers++; showNotification(`Recompensa de evento: Voc√™ ganhou um b√≥nus de Cliques Autom√°ticos!`, 'discovery');
                } else if (bonusRoll < 0.66) {
                    gameState.bonuses.energyBursts++; showNotification(`Recompensa de evento: Voc√™ ganhou uma Explos√£o de Energia!`, 'discovery');
                } else {
                    gameState.bonuses.superGrowths++; showNotification(`Recompensa de evento: Voc√™ ganhou um Super Crescimento!`, 'discovery');
                }
            } else if (roll < 0.575) { // 42.5% de chance para √Ågua
                const waterGained = Math.floor(Math.random() * 100) + 1;
                gameState.water += waterGained;
                showNotification(`Recompensa de evento: +${waterGained}üíß!`, 'info');
            } else { // 42.5% de chance para Energia
                const energyGained = Math.floor(Math.random() * 100) + 1;
                gameState.energy += energyGained;
                showNotification(`Recompensa de evento: +${energyGained}‚ú®!`, 'info');
            }
            updateBonusUI();
        }

        function triggerPollutionEvent() {
            unlockEntry('pollutionEvent');
            const DURATION = 30; const CLICKS_TO_CLEAR = 10;
            gameState.activeEvent = { type: 'pollution', timeLeft: DURATION, duration: DURATION, clicksLeft: CLICKS_TO_CLEAR };
            showNotification("ALERTA: Nuvem de Polui√ß√£o! A sua produ√ß√£o de energia est√° reduzida. Clique na nuvem escura para a limpar!", 'event-start', true);
            const cloud = document.createElement('div'); cloud.id = 'pollution-cloud'; cloud.innerHTML = '‚òÅÔ∏è'; cloud.className = 'absolute text-6xl clickable pollution-cloud'; cloud.style.top = `${Math.random() * 40 + 20}%`; cloud.style.left = `${Math.random() * 40 + 20}%`;
            cloud.addEventListener('click', () => { if (!gameState.activeEvent) return; gameState.activeEvent.clicksLeft--; cloud.style.opacity = gameState.activeEvent.clicksLeft / CLICKS_TO_CLEAR; if (gameState.activeEvent.clicksLeft <= 0) { solvePollutionEvent(); }});
            document.getElementById('event-elements-container').appendChild(cloud);
        }
        function solvePollutionEvent() { 
            showNotification("Ufa! A polui√ß√£o foi limpa e as suas plantas respiram aliviadas.", 'event-good'); 
            triggerSpecialDrop();
            clearActiveEvent(); 
        }
        function failPollutionEvent() { showNotification("Oh n√£o! A polui√ß√£o dissipou-se, mas levou parte da sua energia.", 'event-bad'); gameState.energy *= 0.75; clearActiveEvent(); }
        function clearActiveEvent() {
            const activeNotif = document.getElementById('active-event-notification'); if(activeNotif) activeNotif.remove();
            gameState.activeEvent = null; document.getElementById('event-elements-container').innerHTML = '';
        }

        function triggerRainEvent() {
            unlockEntry('rainEvent');
            const DURATION = 45; gameState.weatherEvent = { type: 'rain', timeLeft: DURATION, duration: DURATION };
            showNotification("Come√ßou uma Chuva M√°gica! A coleta de √°gua est√° mais forte!", 'info');
            const rainContainer = document.createElement('div'); rainContainer.id = 'rain-container'; rainContainer.className = 'rain-container';
            gameContainerEl.prepend(rainContainer); gameState.weatherEvent.rainInterval = setInterval(() => { for(let i = 0; i < 5; i++) createRaindrop(rainContainer); }, 200);
        }
        function createRaindrop(container) {
            if (!container) return; const drop = document.createElement('div'); drop.innerHTML = 'üíß'; drop.className = 'raindrop'; drop.style.left = `${Math.random() * 100}vw`; drop.style.fontSize = `${Math.random() * 0.8 + 0.5}rem`;
            const duration = Math.random() * 1 + 0.5; drop.style.animationDuration = `${duration}s`; drop.style.animationDelay = `${Math.random() * duration}s`;
            container.appendChild(drop); setTimeout(() => drop.remove(), duration * 1000 + 500);
        }
        function clearWeatherEvent(wasInterrupted = false) {
            if (!gameState.weatherEvent) return; clearInterval(gameState.weatherEvent.rainInterval);
            const rainContainer = document.getElementById('rain-container'); if (rainContainer) rainContainer.remove();
            if (!wasInterrupted) { 
                showNotification("A chuva parou, mas deixou o planeta feliz e hidratado!", 'info');
                triggerSpecialDrop();
            }
            gameState.weatherEvent = null;
        }

        function handleEvents(gameTimeInSeconds) {
            if (gameState.activeEvent) {
                gameState.activeEvent.timeLeft--; const progress = (gameState.activeEvent.timeLeft / gameState.activeEvent.duration) * 100;
                const timerBar = document.getElementById('event-timer-progress-toast'); if (timerBar) timerBar.style.width = `${progress}%`;
                if (gameState.activeEvent.timeLeft <= 0) failPollutionEvent();
            } else { if (gameState.pollutionCleaned >= 2 && Math.random() < 0.005) { if(gameState.weatherEvent) clearWeatherEvent(true); triggerPollutionEvent(); }}
            if (gameState.weatherEvent) { if (gameState.weatherEvent.timeLeft-- <= 0) clearWeatherEvent(); } 
            else { if (!gameState.activeEvent && gameState.autoWaterPerSecond > 0 && Math.random() < 0.008) { triggerRainEvent(); }}
        }
        
        // --- Game Loop ---
        let lastTimestamp = 0;
        function gameLoop(timestamp) {
            if (lastTimestamp === 0) lastTimestamp = timestamp;
            const deltaTime = timestamp - lastTimestamp;
            lastTimestamp = timestamp;

            const timeMultiplier = gameState.activeBonuses.ecoFrenzy.active ? 10 : 1;
            
            if (!gameState.isPausedForRoulette) {
                fineGameTime += deltaTime * timeMultiplier;
            
                let currentAutoWater = gameState.autoWaterPerSecond;
                if (gameState.weatherEvent && gameState.weatherEvent.type === 'rain') { currentAutoWater *= 2; }
                const starSeedBonus = 1 + (gameState.starSeeds * 0.1);
                let effectiveEnergyPerSecond = gameState.energyPerSecond * starSeedBonus;
                if (gameState.activeEvent && gameState.activeEvent.type === 'pollution') { effectiveEnergyPerSecond *= 0.5; }
                
                gameState.water += currentAutoWater * (deltaTime / 1000) * timeMultiplier; 
                gameState.energy += effectiveEnergyPerSecond * (deltaTime / 1000) * timeMultiplier;

                if (gameState.activeBonuses.autoClicker.active) {
                    collectWater(gameState.clickPower * 5 * (deltaTime / 1000) * timeMultiplier);
                    gameState.activeBonuses.autoClicker.timeLeft -= (deltaTime / 1000);
                    if (gameState.activeBonuses.autoClicker.timeLeft <= 0) {
                        gameState.activeBonuses.autoClicker.active = false;
                        showNotification("B√≥nus de Cliques Autom√°ticos terminou!", 'info');
                        updateBonusUI();
                    }
                }
                if (gameState.activeBonuses.superGrowth.active) {
                    gameState.activeBonuses.superGrowth.timeLeft -= (deltaTime / 1000);
                     if (gameState.activeBonuses.superGrowth.timeLeft <= 0) {
                        gameState.activeBonuses.superGrowth.active = false;
                        showNotification("Super Crescimento terminou!", 'info');
                        updateBonusUI();
                    }
                }
                if(gameState.activeBonuses.ecoFrenzy.active) {
                    gameState.activeBonuses.ecoFrenzy.timeLeft -= (deltaTime / 1000);
                     if (gameState.activeBonuses.ecoFrenzy.timeLeft <= 0) {
                        gameState.activeBonuses.ecoFrenzy.active = false;
                        showNotification("Frenesi Ecol√≥gico terminou!", 'info');
                        updateBonusUI();
                    }
                }
            }
            
            updateDisplay();
            updateDayNightCycle();
            requestAnimationFrame(gameLoop);
        }

        let lastSecond = 0;
        setInterval(() => {
             const gameTimeInSeconds = Math.floor(fineGameTime / 1000);
             if (gameTimeInSeconds === lastSecond) return;
             lastSecond = gameTimeInSeconds;
             
            if (gameState.isPausedForRoulette) return;
            
            let needsRerender = false;
            const growthRate = gameState.activeBonuses.superGrowth.active ? 5 : 1;
            const frenzyRate = gameState.activeBonuses.ecoFrenzy.active ? 10 : 1;
            
            gameState.plants.forEach(plant => {
                if (plant.type === 'sapling') {
                    plant.age += growthRate * frenzyRate;
                    if (plant.age >= 300) { // 300 segundos (5 minutos) para crescer
                        plant.type = 'adultTree';
                        gameState.energyPerSecond += 2; // B√≥nus de +2 (total 3)
                        unlockEntry('adultTree');
                        needsRerender = true;
                    }
                }
            });
            if (needsRerender) renderAll();

            handleEvents(gameTimeInSeconds); 
            checkMissions(true); // Check missions every second
        }, 1000);
        
        setInterval(saveGame, 10000);
        closeTutorialBtn.addEventListener('click', () => { tutorialMessage.style.display = 'none'; });

        // --- Miss√µes ---
        const allMissions = [
            { id: 1, text: "Comece a sua jornada: plante 5 mudas.", target: 5, type: 'count', item: 'sapling', reward: { water: 50 } },
            { id: 3, text: "Primeiros passos: atinja 5 ‚ú®/s.", target: 5, type: 'rate', item: 'energy', reward: { water: 100 } },
            { id: 4, text: "Mundo mais limpo: limpe a polui√ß√£o 1 vez.", target: 1, type: 'count', item: 'cleanup', reward: { water: 150, energy: 150 } },
            { id: 2, text: "Pequena floresta: tenha 10 plantas no total.", target: 10, type: 'count', item: 'anyPlant', reward: { energy: 100 } },
            { id: 5, text: "Flores√ßa: plante 3 flores.", target: 3, type: 'count', item: 'flower', reward: { energy: 200 } },
            { id: 6, text: "Ecossistema a crescer: atinja 25 ‚ú®/s.", target: 25, type: 'rate', item: 'energy', reward: { bonus: { type: 'autoClickers', amount: 1 } } },
            { id: 7, text: "Amigo das abelhas: atraia a sua primeira abelha.", target: 1, type: 'count', item: 'bee', reward: { energy: 500 } },
            { id: 8, text: "√Årvores s√°bias: fa√ßa crescer 3 √°rvores adultas.", target: 3, type: 'count', item: 'adultTree', reward: { water: 300 } },
            { id: 9, text: "Guardi√£o do Planeta: limpe a polui√ß√£o 5 vezes.", target: 5, type: 'count', item: 'cleanup', reward: { bonus: { type: 'superGrowths', amount: 1 } } },
            { id: 10, text: "Pot√™ncia M√°xima: atinja 75 ‚ú®/s.", target: 75, type: 'rate', item: 'energy', reward: { bonus: { type: 'energyBursts', amount: 1 } } }
        ];
        
        function getActiveMissions() {
            const active = [];
            for (const mission of allMissions) {
                if (!gameState.completedMissions.includes(mission.id)) {
                    active.push(mission);
                    if (active.length >= 3) break;
                }
            }
            return active;
        }

        function checkMissions(isIntervalCheck = false) {
            const activeMissions = getActiveMissions();
            let rewardIsReady = false;
            for(const mission of activeMissions) {
                 if(isMissionComplete(mission)) {
                     rewardIsReady = true;
                     break;
                 }
            }
            if(rewardIsReady) {
                missionsBtn.classList.add('reward-ready');
            } else {
                missionsBtn.classList.remove('reward-ready');
            }
             if (isIntervalCheck && missionsModal.classList.contains('hidden') === false) {
                renderMissions();
            }
        }

        function getCurrentProgress(mission) {
            const starSeedBonus = 1 + (gameState.starSeeds * 0.1);
            switch(mission.item) {
                case 'sapling': return gameState.plants.filter(p => p.type === 'sapling').length;
                case 'anyPlant': return gameState.plants.length;
                case 'flower': return gameState.plants.filter(p => p.type === 'flower').length;
                case 'adultTree': return gameState.plants.filter(p => p.type === 'adultTree').length;
                case 'energy': return gameState.energyPerSecond * starSeedBonus;
                case 'cleanup': return gameState.pollutionCleaned;
                case 'bee': return gameState.animals.filter(a => a.type === 'bee').length;
                default: return 0;
            }
        }
        
        function isMissionComplete(mission) {
            return getCurrentProgress(mission) >= mission.target;
        }

        function renderMissions() {
            missionsListEl.innerHTML = '';
            const activeMissions = getActiveMissions();
            if (activeMissions.length === 0) {
                 missionsListEl.innerHTML = `<p class="text-center">Parab√©ns, voc√™ completou todas as miss√µes dispon√≠veis!</p>`;
                 return;
            }
            activeMissions.forEach(mission => {
                const progress = getCurrentProgress(mission);
                const isComplete = progress >= mission.target;
                const progressPercent = Math.min(100, (progress / mission.target) * 100);

                const missionEl = document.createElement('div');
                missionEl.className = 'bg-white/50 p-4 rounded-lg';
                
                let rewardText = '';
                if(mission.reward.water) rewardText += `${mission.reward.water}üíß `;
                if(mission.reward.energy) rewardText += `${mission.reward.energy}‚ú® `;
                if(mission.reward.bonus) {
                    let bonusName = '';
                    if (mission.reward.bonus.type === 'autoClickers') bonusName = 'Cliques Autom√°ticos';
                    else if (mission.reward.bonus.type === 'energyBursts') bonusName = 'Explos√£o de Energia';
                    else if (mission.reward.bonus.type === 'superGrowths') bonusName = 'Super Crescimento';
                    rewardText += `1x ${bonusName}`;
                }
                
                missionEl.innerHTML = `
                    <p class="font-bold">${mission.text}</p>
                    <div class="flex items-center gap-2 my-2">
                        <div class="progress-bar flex-1">
                            <div class="progress-bar-fill" style="width: ${progressPercent}%"></div>
                        </div>
                        <span class="text-sm">${Math.floor(progress)}/${mission.target}</span>
                    </div>
                    <p class="text-sm">Recompensa: ${rewardText}</p>
                    <button class="collect-reward-btn w-full mt-2 p-2 rounded-lg bg-green-500 text-white hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed" 
                            data-mission-id="${mission.id}" ${!isComplete ? 'disabled' : ''}>
                        Coletar
                    </button>
                `;
                missionsListEl.appendChild(missionEl);
            });
            
            document.querySelectorAll('.collect-reward-btn').forEach(btn => {
                btn.onclick = (e) => {
                    const missionId = parseInt(e.target.dataset.missionId);
                    const mission = allMissions.find(m => m.id === missionId);
                    if (mission && !gameState.completedMissions.includes(missionId) && isMissionComplete(mission)) {
                        if(mission.reward.water) gameState.water += mission.reward.water;
                        if(mission.reward.energy) gameState.energy += mission.reward.energy;
                        if(mission.reward.bonus) gameState.bonuses[mission.reward.bonus.type] += mission.reward.bonus.amount;
                        
                        gameState.completedMissions.push(missionId);
                        showNotification("Miss√£o conclu√≠da!", 'discovery');
                        updateDisplay();
                        renderMissions();
                    }
                };
            });
        }
        
        // --- Eventos Especiais (Estrela Cadente, Cometa) ---
        function triggerShootingStar() {
            const star = document.createElement('div');
            star.id = 'shooting-star';
            star.innerHTML = 'üí´';
            star.className = 'absolute text-4xl';
            specialEventsContainer.appendChild(star);

            star.addEventListener('click', () => {
                showNotification('Voc√™ pegou uma estrela cadente!', 'discovery');
                star.remove();
                dropGiftBox();
            });

            setTimeout(() => {
                star.remove();
            }, 4000);
        }

        function dropGiftBox() {
            const gift = document.createElement('div');
            gift.innerHTML = 'üéÅ';
            gift.className = 'planet-item clickable text-4xl spawn-animation';
             const data = { position: { angle: Math.random() * 360, distance: Math.random() * 80 + 20 } };
            gift.style.transform = `rotate(${data.position.angle}deg) translateY(-${data.position.distance}%) rotate(-${data.position.angle}deg)`;
            
            gift.addEventListener('click', () => {
                gift.remove();
                openGiftBox();
            }, { once: true });
            
            planetEl.appendChild(gift);
        }

        function openGiftBox() {
            triggerSpecialDrop();
        }

        function triggerComet() {
            const comet = document.createElement('div');
            comet.id = 'comet';
            comet.innerHTML = '‚òÑÔ∏è';
            comet.className = 'absolute text-6xl';
            specialEventsContainer.appendChild(comet);
            
            comet.addEventListener('click', () => {
                comet.remove();
                gameState.starSeeds++;
                starSeedModalCountEl.textContent = gameState.starSeeds;
                starSeedModal.classList.remove('hidden');
                updateDisplay();
            }, { once: true });
            
            setTimeout(() => { comet.remove(); }, 10000);
        }

        // --- Iniciar Jogo ---
        loadGame();
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>
